name: iOS IPA (Ücretsiz)
on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v3
        with: { distribution: 'zulu', java-version: 17 }

      - uses: actions/cache@v3
        with:
          path: ~/.konan
          key: konan-${{ runner.os }}

      - run: chmod +x ./gradlew
      - run: ./gradlew :shared:packForXcode

      - name: Create minimal iOS app
        run: |
          mkdir iosApp
          cd iosApp

          # Basit iOS uygulaması
          cat > main.m <<'EOF'
          #import <UIKit/UIKit.h>
          int main(int argc, char *argv[]) {
              @autoreleasepool { return UIApplicationMain(argc, argv, nil, nil); }
          }
          EOF

          cat > Info.plist <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
           "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleIdentifier</key><string>com.example.AutoSSTP</string>
            <key>CFBundleName</key><string>AutoSSTP</string>
            <key>CFBundleVersion</key><string>1</string>
            <key>CFBundleShortVersionString</key><string>1.0</string>
            <key>LSRequiresIPhoneOS</key><true/>
            <key>UIRequiredDeviceCapabilities</key><array><string>arm64</string></array>
          </dict>
          </plist>
          EOF

          xcodebuild \
            -create-xcodeproj \
            -project AutoSSTP.xcodeproj \
            -app AutoSSTP \
            -template default \
            -sdk iphoneos \
            -configuration Release \
            -archivePath build/Archive.xcarchive \
            archive \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -quiet

          APP=$(find build/Archive.xcarchive -name '*.app' | head -n 1)
          if [ -n "$APP" ]; then
            zip -r AutoSSTP-iOS.zip "$APP"
          else
            echo ".app bulunamadı"; exit 1
          fi

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: AutoSSTP-iOS
          path: iosApp/AutoSSTP-iOS.zip